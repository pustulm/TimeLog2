name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
    
  workflow_dispatch:
    inputs:
      tfpath:
        description: 'TF Code Path'     
        required: false
        default: 'kubernetes'


jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - 
      name: Checkout 
      uses: actions/checkout@v3
    - 
      name: Login to DockerHUB
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    -
      name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/timelog2:latest
    if:  ${{ inputs.tfpath }} 
    - name: Checkout Code
      uses: actions/checkout@v2.5.0
    
    - name: Install Minikube for GitHub Actions
      uses: medyagh/setup-minikube@v0.0.13
      
    - name: Install Kubectl tool for GitHub Actions
      uses: Azure/setup-kubectl@v3

    - name: Setup Terraform CLI
      uses: hashicorp/setup-terraform@v2.0.2

    - name: Terraform init and velidate and plan
      run: |
        echo `pwd`
        echo "tfpath ${{ github.event.inputs.tfpath }}"
        echo "** Running Terraform Init**"
        terraform init
        
        echo "** Running Terraform Validate**"
        terraform validate
        
        echo "** Running Terraform Plan**"
        terraform plan
      working-directory: ${{ github.event.inputs.tfpath }}

    - name: Terraform Apply
      run: |
        echo "** Running Terraform Apply**"
        terraform apply -auto-approve
      working-directory: ${{ github.event.inputs.tfpath }}

    - name: Verify Kubernetes Deployment
      run: |
        echo "** kubectl get deployment **"
        kubectl get deployment -n ns-created-by-tf
  
    - name: Terraform Destroy
      run: |
        echo "** Running Terraform Destroy**"
        terraform plan -destroy
      working-directory: ${{ github.event.inputs.tfpath }}
